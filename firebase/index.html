<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<title></title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

body {
    background-color: rgba(66, 171, 171, 0.454);
}

.center {
    display: flex;
    justify-content: center;
    font-size: x-large;
}
.center #sentence {
    font-size: x-large;
    border: none;
    width: 600px;
    padding-top: 30px;
}

</style>
</head>
<body>
    <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js'
    import { getFirestore, collection, getDocs, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA7qdZKWosZtMSdXYNgEyfR_W4nYDUL74E",
        authDomain: "striking-coil-320623.firebaseapp.com",
        projectId: "striking-coil-320623",
        storageBucket: "striking-coil-320623.appspot.com",
        messagingSenderId: "767899227033",
        appId: "1:767899227033:web:d38bc60de68b01a3e4f908",
        measurementId: "G-HSNFZN8HB3"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let sentenceDocument = "";
    let sentence = "";
    let returnCharCounter = 0;

    function addCharacters(doc) {
        //console.log("Current data: ", doc.data());
        //Try to find the next character each time.
        
        let charCounterString = "characterCheckNumber" + returnCharCounter.toString();
        console.log(doc.get(charCounterString))
        try {
            document.getElementById("result").innerHTML += doc.get(charCounterString)["randomCharacter"];
        }
        catch {

        }
        returnCharCounter++
    }

    function setupFireStoreDocument(result) {
        // Receives a result like "projects/striking-coil-320623/databases/(default)/documents/sentences/8QIpt49fJ0IuZKUCEDKc"
        // and configure a listener for the correct firestore document
        result = result.slice(1,-1); //Remove the extra '' on the result :shrug
        sentenceDocument = result;
        let sentenceDocumentID = result.split("/").at(-1) //Get the key at the end of the result 8QIpt49fJ0IuZKUCEDKc
        
        const unsub = onSnapshot(doc(db, "sentences", sentenceDocumentID), (doc) => {
            addCharacters(doc);
        });

        //Kick off the sentence processing with the 2nd workflow
        let data = {}
        data.sentence = document.getElementById("sentence_input").value;
        data.fs_document = sentenceDocument

        var requestOptions = {
            method: 'POST',
            body: JSON.stringify(data),
            headers: {
                "Content-Type": "application/json"
            },
        };

        fetch("https://us-central1-striking-coil-320623.cloudfunctions.net/cf-step-2", requestOptions)
            .then(response => response.text())
            .then(result => console.log(result))
            .catch(error => console.log('error', error));
    }

    function sendSentence() {
        document.getElementById("submitButton").disabled = true; //disable the button for now 
        var requestOptions = {
            method: 'POST'
        };

        fetch("https://us-central1-striking-coil-320623.cloudfunctions.net/cf-step-1", requestOptions)
            .then(response => response.text())
            .then(result => setupFireStoreDocument(result))
            .catch(error => console.log('error', error));
    }

    function pageSetup() {
        //Hookup event handling
        document.getElementById("submitButton").onclick = sendSentence;
    }
    
    pageSetup();
    
    </script>
    
    <div class="center">
        <div class="child">
            <label for="sentence">Update the sentence below to what you would like to match:</label><br>
            <input type="text" id="sentence_input" name="sentence" value="You Shall Not Pass!"><br>
            <input id ="submitButton" type="submit" value="Match">
        </div>
      </div>

      <div class="center">
        <p id="result"></p>
      </div>      


</body>
</html>